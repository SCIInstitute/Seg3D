name: windows-build

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  windows-build-gui:
    strategy:
      matrix:
        qtversion: [5.15.2]
        include:
          - qtversion: 5.15.2
            qtarch: win64_msvc2019_64
            cmake-generator: "Visual Studio 17 2022"
            cmake-arch: x64
            cmake-toolset: v143
    runs-on: windows-2022

    steps:

    - name: Checkout
      uses: actions/checkout@v3

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ matrix.qtversion }}
        target: desktop
        host: windows
        arch: ${{ matrix.qtarch }}
        install-deps: true

    - name: Configure
      working-directory: bin
      run: |
        cmake `
          ..\Superbuild `
          -DCMAKE_BUILD_TYPE=Release `
          -G"${{ matrix.cmake-generator }}" `
          -A${{ matrix.cmake-arch }} `
          -T${{ matrix.cmake-toolset }} `
          -DQt5_PATH:PATH="$env:Qt5_Dir" `
          -DBUILD_WITH_PYTHON:BOOL=OFF

    - name: Compile
      working-directory: bin
      shell: cmd
      run: cmake --build . --config Release -j 3

    - name: Package
      working-directory: bin/Seg3D
      shell: cmd
      run: cmake --build . --config Release --target package

    - name: Upload installer
      uses: actions/upload-artifact@v3
      with:
        name: Seg3DWindowsInstaller_${{ matrix.qtversion }}
        path: bin/Seg3D/Seg3D2-2.*-win64.exe
